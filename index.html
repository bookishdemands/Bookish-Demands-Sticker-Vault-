<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bookish Demands Sticker Vault — v2</title>

  <style>
    :root{
      --bg:#0f0f14;
      --panel: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.10);
      --text:#f3f3f7;
      --muted:#a9a9b7;
      --accent:#ff4fa3;
      --shadow: 0 12px 34px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(255,79,163,.18), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(32,227,178,.14), transparent 55%),
        radial-gradient(900px 500px at 40% 110%, rgba(255,205,115,.10), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:1250px;margin:0 auto;padding:24px 16px 60px}
    header{display:flex;flex-wrap:wrap;align-items:flex-end;justify-content:space-between;gap:14px;margin-bottom:16px}
    h1{margin:0;font-size:clamp(22px,3.2vw,34px);letter-spacing:.2px}
    .subtitle{color:var(--muted);line-height:1.35;max-width:100ch;margin-top:6px}
    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:16px;margin-top:18px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .cardHead{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.07);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .cardHead h2{margin:0;font-size:14px;letter-spacing:.6px;text-transform:uppercase;color:rgba(243,243,247,.9)}
    .mini{
      font-family:var(--mono);
      font-size:11.5px;
      color:rgba(243,243,247,.85);
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;padding:6px 10px;white-space:nowrap
    }
    .cardBody{padding:14px 16px 16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    @media (max-width:620px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    select,input[type="text"],textarea{
      width:100%;padding:10px 11px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.25);color:var(--text);outline:none
    }
    textarea{min-height:118px;font-family:var(--mono);font-size:12.5px;line-height:1.35;resize:vertical}
    .toggle{
      display:flex;align-items:flex-start;gap:10px;padding:10px 11px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);color:var(--muted);user-select:none
    }
    .toggle input{width:18px;height:18px;margin-top:2px}
    .buttons{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      border:0;border-radius:999px;padding:11px 14px;font-weight:900;letter-spacing:.15px;cursor:pointer;
      color:#0f0f14;background:linear-gradient(135deg,var(--accent),#ffcc73);box-shadow:0 10px 25px rgba(255,79,163,.18)
    }
    button.secondary{background:rgba(255,255,255,.08);color:var(--text);border:1px solid rgba(255,255,255,.12);box-shadow:none}
    button.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18);box-shadow:none}
    button:active{transform:translateY(1px)}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
    .hint{color:var(--muted);font-size:12px;line-height:1.45;margin-top:8px}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(20,20,30,.92);border:1px solid rgba(255,255,255,.12);color:var(--text);
      padding:10px 12px;border-radius:999px;font-size:12px;opacity:0;pointer-events:none;
      transition:opacity .18s ease;box-shadow:var(--shadow);max-width:calc(100vw - 24px);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;z-index:9999
    }
    .toast.show{opacity:1}
    .bankGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:820px){.bankGrid{grid-template-columns:1fr}}
    .bankBox{
      padding:10px 11px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.16)
    }
    .bankTitle{font-size:12px;color:rgba(243,243,247,.9);font-weight:900;letter-spacing:.5px;margin-bottom:8px}
    .checkRow{display:flex;gap:10px;align-items:flex-start;color:var(--muted);padding:6px 0}
    .checkRow input{width:18px;height:18px;margin-top:2px}
    .footerNote{margin-top:14px;color:var(--muted);font-size:12px;line-height:1.5}
    .footerNote b{color:var(--text)}
    .pillWarn{
      margin-top:10px;
      padding:10px 11px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,80,120,.08);
      border-radius:14px;
      color:rgba(243,243,247,.88);
      font-size:12px;
      line-height:1.35;
    }
    .pillWarn b{color:#ffd5e8}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Bookish Demands Sticker Vault — v2</h1>
        <div class="subtitle">
          Prompt engine for <b>Urban Fiction</b>, <b>Dark Romance</b>, <b>Horror</b>, <b>Black Paranormal</b>, <b>Black Romance</b>, <b>Thriller</b>, <b>Fantasy</b> + vibes/tropes.
          Includes <b>harmony rules</b> (Horror → red/black), <b>hand-drawn preset</b>, <b>product expansions</b>, <b>smarter label logic</b>, and <b>cut-safe containment</b> that applies to <b>ALL accents</b>.
        </div>
      </div>
      <div class="mini" id="statusPill">Ready</div>
    </header>

    <div class="grid">
      <!-- INPUTS -->
      <section class="card">
        <div class="cardHead">
          <h2>Inputs</h2>
          <span class="mini">Random picks: 1–2 banks max ✅</span>
        </div>
        <div class="cardBody">

          <div class="row">
            <div>
              <label for="count">How many prompts?</label>
              <select id="count">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3" selected>3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>

            <div>
              <label for="stickerType">Sticker Type</label>
              <select id="stickerType">
                <option value="packaging" selected>Packaging / Product Label Sticker</option>
                <option value="icon_quote">Icon + Quote</option>
                <option value="icon_only">Icon Only (no text)</option>
                <option value="quote_only">Quote Only (typography sticker)</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="genreTone">Genre Tone (None allowed)</label>
              <select id="genreTone">
                <option value="">None</option>
                <option value="urban_fiction">Urban Fiction</option>
                <option value="dark_romance">Dark Romance</option>
                <option value="horror">Horror</option>
                <option value="black_paranormal">Black Paranormal Romance</option>
                <option value="black_romance">Black Romance</option>
                <option value="thriller">Thriller / Suspense</option>
                <option value="fantasy">Fantasy</option>
                <option value="soft_glam_reader">Soft Glam Reader</option>
                <option value="bookish_luxe">Bookish Luxe</option>
              </select>
            </div>

            <div>
              <label for="variation">Variation (mood/style/aesthetic)</label>
              <select id="variation">
                <option value="">None</option>
                <option value="bold_vector">Bold Vector Sticker</option>
                <option value="cute_clipart">Cute Flat Clipart</option>
                <option value="hand_drawn">Hand-Drawn Illustration</option>
                <option value="hand_doodle">Hand-Doodle Charm</option>
                <option value="booktok_pop">BookTok Pop-Art</option>
                <option value="noir_minimal">Noir Minimal</option>
                <option value="neon_noir">Neon Noir</option>
                <option value="luxury_editorial">Luxury Editorial</option>
                <option value="vintage_label">Vintage Apothecary Label</option>
                <option value="kawaii_goth">Kawaii Goth</option>
              </select>
            </div>
          </div>

          <div class="row">
            <label class="toggle" style="grid-column:1/-1;">
              <input id="handDrawnPreset" type="checkbox" />
              <div>
                <b>Hand-Drawn preset</b> (forces “Hand-Drawn Illustration” variation + adds hand-drawn rules)
              </div>
            </label>
          </div>

          <div class="row">
            <div>
              <label for="vibe">Vibe (None allowed)</label>
              <select id="vibe">
                <option value="">None</option>
                <option>Street Luxe Romance</option>
                <option>Midnight Confessions</option>
                <option>Forbidden Attraction</option>
                <option>Jealous Enemy Plot</option>
                <option>Protective Possessive Energy</option>
                <option>Booktrovert Peace Mode</option>
                <option>Kindle After Dark</option>
                <option>Morally Gray Glam</option>
                <option>Thriller — Cold Case Energy</option>
                <option>Fantasy — Divine & Dangerous</option>
                <option>Witchy City Glam</option>
                <option>Coven Chic</option>
                <option>Luxury Reader Baddie</option>
                <option>Intellectual Villain Era</option>
                <option>Soft Life But Savage</option>
                <option>Slow Burn</option>
              </select>
            </div>

            <div>
              <label for="productTheme">Product Theme (None allowed)</label>
              <select id="productTheme">
                <option value="">None</option>

                <!-- Medical / Pharma -->
                <option value="iv_bag">IV Bag</option>
                <option value="pill_bottle">Pill Bottle / Prescription Bottle</option>
                <option value="prescription_pad">Prescription Pad</option>
                <option value="specimen_vial">Lab Specimen Vial</option>
                <option value="elixir_dropper">Love Potion / Elixir Dropper Bottle</option>
                <option value="blood_pressure">Blood Pressure Monitor</option>
                <option value="heart_monitor">Heartbeat / Monitor Screen</option>

                <!-- Tags / Receipts / Cards -->
                <option value="library_card">Library Card / Checkout Slip</option>
                <option value="guest_check">Guest Check</option>
                <option value="tbr_receipt">TBR Receipt (store receipt aesthetic)</option>
                <option value="evidence_tag">Evidence Tag + Barcode Label</option>
                <option value="confession_note">Confession Note</option>
                <option value="sticky_memo">Sticky Memo Notes</option>
                <option value="name_tag">Name Tag (Hello, I am…)</option>
                <option value="door_tag">Door Tag (Do Not Disturb…)</option>

                <!-- Meters / Scales / Signs -->
                <option value="delulu_meter">Meter (Delulu / Obsessed)</option>
                <option value="spice_scale">Spice Scale</option>
                <option value="caution_sign">Caution Sign</option>

                <!-- Witchy / Bookish Objects -->
                <option value="wax_seal">Wax Seal Stamp Kit</option>
                <option value="spell_candle">Candle Jar / Spell Candle</option>
                <option value="tarot_pack">Tarot Card Pack</option>
                <option value="fortune_cookie">Fortune Cookie</option>
                <option value="magic_8_ball">Magic 8 Ball</option>
                <option value="glass_fortune_ball">Glass Fortune Ball</option>

                <!-- Lifestyle -->
                <option value="matchbook">Matchbook / Matchbox</option>
                <option value="polaroid_frame">Polaroid Photo Frame</option>
                <option value="nail_polish">Nail Polish Bottle</option>
                <option value="coffee_cup">Coffee / Iced Coffee / Tea Cup</option>
                <option value="phone_dnd">Phone Screen (DND)</option>

                <!-- Bookish -->
                <option value="book_stack">Stack of Books</option>
                <option value="bookmark_sneakerlace">Bookmark + Sneaker Lace Combo</option>
                <option value="book_review_card">Book Review Card (___… 5 stars)</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="palette">Color Palette (None allowed)</label>
              <select id="palette"></select>
            </div>
            <div>
              <label for="bgMode">Background</label>
              <select id="bgMode">
                <option value="transparent" selected>Transparent background</option>
                <option value="solid_white">Solid white background</option>
                <option value="none_specified">Don’t specify</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="border">Sticker Border</label>
              <select id="border">
                <option value="white" selected>White border (recommended)</option>
                <option value="none">No border</option>
              </select>
            </div>
            <div>
              <label for="outline">Outline</label>
              <select id="outline">
                <option value="bold_black" selected>Thick bold outline</option>
                <option value="no_outline">No outline</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="spiceLevel">Spice Level (1–5)</label>
              <select id="spiceLevel">
                <option value="1">1 — sweet tension</option>
                <option value="2" selected>2 — flirty heat</option>
                <option value="3">3 — spicy vibes</option>
                <option value="4">4 — dark romance heat (non-graphic)</option>
                <option value="5">5 — filthy talk energy (non-graphic)</option>
              </select>
            </div>
            <div>
              <label for="typoRule">Typography Rules</label>
              <select id="typoRule">
                <option value="on" selected>Enforce: clear legible typography</option>
                <option value="off">Don’t specify typography rules</option>
              </select>
            </div>
          </div>

          <div class="row">
            <label class="toggle" style="grid-column:1/-1;">
              <input id="blankMode" type="checkbox" />
              <div><b>Blank sticker mode</b> (no label/quote text at all — useful for icon packs)</div>
            </label>
          </div>

          <div class="row">
            <label class="toggle" style="grid-column:1/-1;">
              <input id="cutSafeMode" type="checkbox" checked />
              <div><b>Cut-safe mode</b> (contain smoke/sparkles/glow/particles <b>INSIDE</b> the die-cut silhouette — default ON)</div>
            </label>
          </div>

          <div class="pillWarn" id="harmonyNote" style="display:none;"></div>

          <div class="row">
            <div>
              <label for="labelMode">Label Text Mode</label>
              <select id="labelMode">
                <option value="none">No label text</option>
                <option value="auto" selected>Auto label title + subtitle</option>
                <option value="manual">Use my Title + Subtitle</option>
                <option value="mixed">Manual if provided, otherwise Auto</option>
                <option value="quote_subtitle">Quote as Subtitle (title auto)</option>
              </select>
            </div>
            <div>
              <label for="quoteMode">Quote Mode</label>
              <select id="quoteMode">
                <option value="any" selected>Any</option>
                <option value="micro">Micro (2–5 words)</option>
                <option value="standard">Standard (witty lines)</option>
              </select>
            </div>
          </div>
          <div class="row" id="screenModeRow" style="display:none;">
  <div>
    <label for="screenMode">Monitor Screen Mode</label>
    <select id="screenMode">
      <option value="auto" selected>Auto (smart)</option>
      <option value="vitals">Vitals (120/80, SYS/DIA, BPM)</option>
      <option value="genre">Genre (big text)</option>
      <option value="trope">Trope (big text)</option>
      <option value="custom">Custom text</option>
    </select>
  </div>

  <div id="customScreenTextWrap" style="display:none;">
    <label for="customScreenText">Custom Screen Text</label>
    <input id="customScreenText" type="text" maxlength="18" placeholder='Example: "AGE GAP" or "120/80"' />
  </div>
</div>
          
          <div class="row">
            <div>
              <label for="titleText">Title (optional)</label>
              <input id="titleText" type="text" maxlength="60" placeholder='Example: "EMERGENCY ROMANCE SUPPLY"' />
            </div>
            <div>
              <label for="subtitleText">Subtitle (optional)</label>
              <input id="subtitleText" type="text" maxlength="90" placeholder='Example: "99% Delulu • 1% Regret"' />
            </div>
          </div>

          <div class="row">
            <label class="toggle" style="grid-column:1/-1;">
              <input id="useRandomQuote" type="checkbox" checked />
              <div><b>Use random quote</b> (you can still type a quote to override)</div>
            </label>
          </div>

          <div class="row">
            <div>
              <label for="quote">Quote (optional override)</label>
              <input id="quote" type="text" maxlength="140" placeholder='Example: "Remaining in Bookland until further notice."' />
            </div>
            <div>
              <label for="quoteUsage">Quote usage</label>
              <select id="quoteUsage">
                <option value="smart" selected>Smart (depends on sticker type)</option>
                <option value="always">Always include quote (if not blank)</option>
                <option value="never">Never include quote line</option>
              </select>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div>
              <label for="customMainObject">Custom Main Object (optional)</label>
              <input id="customMainObject" type="text" maxlength="140" placeholder='Example: "sparkly Kindle + sneaker charm"' />
            </div>
            <div>
              <label for="customVibe">Custom Vibe (optional)</label>
              <input id="customVibe" type="text" maxlength="140" placeholder='Example: "Midnight Book Bae Energy"' />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="customPalette">Custom Palette (optional)</label>
              <input id="customPalette" type="text" maxlength="140" placeholder='Example: "blood red + ink black + steel"' />
            </div>
            <div>
              <label for="customAccents">Custom Accents (optional)</label>
              <input id="customAccents" type="text" maxlength="140" placeholder='Example: "gold foil flecks + glitter dots"' />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="customProductTheme">Custom Product Theme (optional)</label>
              <input id="customProductTheme" type="text" maxlength="160" placeholder='Example: "guest check receipt sticker"' />
            </div>
            <div>
              <label for="customQuotes">Custom Quote Bank (optional — one per line)</label>
              <textarea id="customQuotes" placeholder="Add your own quotes here. If filled, random quotes will pull from here first."></textarea>
            </div>
          </div>

          <div class="divider"></div>

          <div class="bankGrid">
            <div class="bankBox">
              <div class="bankTitle">CORE (Random picks 1–2 max)</div>

              <label class="checkRow">
                <input type="checkbox" id="bGeneralUrbanBookish" checked>
                <span>General Urban Bookish</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="bTBRKindleBooktok">
                <span>TBR / Kindle / BookTok</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="bMorallyGray">
                <span>Morally Gray (toggle)</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="bUnhingedMMC">
                <span>Unhinged MMC (possessive/protective)</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="bStreetLingo">
                <span>Street / Urban Lingo</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="bMoodQuotes" checked>
                <span>Mood Quotes (your list)</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="bIYKYK" checked>
                <span>IYKYK (inside-joke coded)</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="bAudiobook">
                <span>Audiobook / Narrator-coded</span>
              </label>
            </div>

            <div class="bankBox">
              <div class="bankTitle">GENRES (Quote flavor toggles)</div>

              <label class="checkRow">
                <input type="checkbox" id="gUrbanFiction">
                <span>Urban Fiction</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="gBlackRomance">
                <span>Black Romance</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="gDarkRomance">
                <span>Dark Romance (non-graphic)</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="gBlackParanormal">
                <span>Black Paranormal Romance</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="gThriller">
                <span>Thriller / Suspense</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="gHorror">
                <span>Horror</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="gFantasy">
                <span>Fantasy</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="gBookishLuxe">
                <span>Bookish Luxe</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="gSoftGlam">
                <span>Soft Glam Reader</span>
              </label>
            </div>
          </div>

          <div class="divider"></div>

          <div class="bankBox">
            <div class="bankTitle">TROPES (Random picks 0–2 max)</div>

            <label class="checkRow"><input type="checkbox" id="tWealthyMMC"><span>Wealthy / Billionaire MMC</span></label>
            <label class="checkRow"><input type="checkbox" id="tAgeGap"><span>Age Gap</span></label>
            <label class="checkRow"><input type="checkbox" id="tStepDaddyMMC"><span>Step-Daddy MMC (he steps up as ideal father figure)</span></label>
            <label class="checkRow"><input type="checkbox" id="tEnemiesToLovers"><span>Enemies to Lovers</span></label>
            <label class="checkRow"><input type="checkbox" id="tFriendsToLovers"><span>Friends to Lovers</span></label>
            <label class="checkRow"><input type="checkbox" id="tForcedProximity"><span>Forced Proximity</span></label>
            <label class="checkRow"><input type="checkbox" id="tFakeDating"><span>Fake Dating</span></label>
            <label class="checkRow"><input type="checkbox" id="tSecondChance"><span>Second Chance</span></label>
            <label class="checkRow"><input type="checkbox" id="tForbiddenRomance"><span>Forbidden Romance</span></label>
            <label class="checkRow"><input type="checkbox" id="tSecretBaby"><span>Secret Baby</span></label>
            <label class="checkRow"><input type="checkbox" id="tMarriageConvenience"><span>Marriage of Convenience</span></label>
            <label class="checkRow"><input type="checkbox" id="tBossAssistant"><span>Boss / Assistant</span></label>
            <label class="checkRow"><input type="checkbox" id="tBodyguard"><span>Protector / Bodyguard</span></label>
            <label class="checkRow"><input type="checkbox" id="tWhoDidThis"><span>“Who did this to you?”</span></label>
            <label class="checkRow"><input type="checkbox" id="tTouchHerDie"><span>“Touch her and die” energy</span></label>
            <label class="checkRow"><input type="checkbox" id="tBlackCatGolden"><span>Black Cat FMC × Golden Retriever MMC</span></label>

            <label class="checkRow"><input type="checkbox" id="tReverseHarem"><span>Reverse Harem</span></label>
            <label class="checkRow"><input type="checkbox" id="tMMF"><span>MMF</span></label>
            <label class="checkRow"><input type="checkbox" id="tMFM"><span>MFM</span></label>
            <label class="checkRow"><input type="checkbox" id="tMMFMM"><span>MMFMM</span></label>
            <label class="checkRow"><input type="checkbox" id="tMMMF"><span>MMMF</span></label>
          </div>

          <div class="buttons">
            <button id="generateBtn">Generate</button>
            <button class="secondary" id="copyBtn">Copy Prompt</button>
            <button class="ghost" id="randomBtn">Randomize</button>
            <button class="ghost" id="clearBtn">Clear All</button>
          </div>

          <div class="hint">
            <b>Fix for your sparkle issue:</b> when Cut-safe is ON, the prompt explicitly says <b>all accents</b> (sparkles, foil flecks, glitter dots, smoke wisps, shine pops, glow) must be <b>fully inside</b> the silhouette with <b>no stray dots</b> outside the outline.
          </div>
        </div>
      </section>

      <!-- OUTPUTS -->
      <section class="card">
        <div class="cardHead">
          <h2>Outputs</h2>
          <span class="mini">Ideogram-ready ✅</span>
        </div>
        <div class="cardBody">
          <div style="margin-bottom:12px;">
            <label for="promptOut">Prompt</label>
            <textarea id="promptOut" readonly></textarea>
          </div>

          <div style="margin-bottom:12px;">
            <label for="negOut">Negative Prompt</label>
            <textarea id="negOut" readonly></textarea>
          </div>

          <div>
            <label for="notesOut">Export Notes</label>
            <textarea id="notesOut" readonly></textarea>
          </div>

          <div class="footerNote">
            <b>Commercial safety:</b> keep it original — avoid brand names/logos, real book titles, celebrity likeness, and copyrighted characters.
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast">Copied!</div>

  <script>
    // ---------- DOM helpers ----------
    const $ = (id)=>document.getElementById(id);
    const v = (id)=>($(id)?.value ?? "");
    const setV = (id,val)=>{ if($(id)) $(id).value = val; };
    const c = (id)=>!!($(id)?.checked);
    const setC = (id,val)=>{ if($(id)) $(id).checked = !!val; };
   // ---------- Re-entrancy guard (prevents infinite loops / call stack) ----------
    let __uiLock = false;

function withUiLock(fn){
  if(__uiLock) return;
  __uiLock = true;
  try { fn(); }
  catch(e){ console.error(e); }   // so you can see errors in console
  finally { __uiLock = false; }
}
  function ensurePaletteOptions(){
  const sel = $("palette");
  if(!sel) return;

  // If already populated, do nothing
  if(sel.options && sel.options.length > 0) return;

  // Minimal safe defaults (you can add/remove as you like)
  const defaults = [
    "Auto (recommended)",
    "Blood Red + Ink Black + Steel",
    "Oxblood + Matte Black + Bone",
    "Champagne Gold + Cocoa + Cream",
    "Neon Red + Charcoal + White",
  ];

  sel.innerHTML = "";
  defaults.forEach((label, i)=>{
    const opt = document.createElement("option");
    opt.value = (i === 0) ? "auto" : label;
    opt.textContent = label;
    sel.appendChild(opt);
  });
}  
    
    /* =========================
   Monitor Screen Mode UI + Logic
   ========================= */

function toggleScreenModeUI(){
  withUiLock(()=>{
    const row = $("screenModeRow");
    const customWrap = $("customScreenTextWrap");
    if(!row) return;

    const on = isMonitorProduct();
    row.style.display = on ? "" : "none";

    if(customWrap){
      const mode = v("screenMode");
      customWrap.style.display = (on && mode === "custom") ? "" : "none";
    }
  });
}

function screenMode(){
  return (v("screenMode") || "auto").trim();
}

// Replace your existing screenTextForMonitor() with this version:
function screenTextForMonitor(){
  const k = v("productTheme");
  const rules = PRODUCT_LAYOUT_RULES[k];
  const maxLen = rules?.screenTextMax ?? 14;

  const mode = screenMode();

  // 1) Custom always wins if selected
  if(mode === "custom"){
    const custom = (v("customScreenText") || "").trim();
    if(custom) return clampText(custom.toUpperCase(), maxLen);
    // if custom chosen but empty, fallback to auto
  }

  // 2) Vitals mode: force vitals examples
  if(mode === "vitals"){
    const examples = rules?.screenExamples || ["120/80","SYS 120 / DIA 80","PULSE 72","BPM 78"];
    // Prefer numeric-looking options
    const vitals = examples.filter(x => /\d/.test(x));
    return clampText(pick(vitals.length ? vitals : examples), maxLen);
  }

  // 3) Genre mode: force genre tone if available
  if(mode === "genre"){
    const g = (v("genreTone") || "").trim();
    if(g) return clampText(g.replaceAll("_"," ").toUpperCase(), maxLen);
    // if no genre selected, fallback to auto
  }

  // 4) Trope mode: force a trope if available
  if(mode === "trope"){
    const tropes = (selectedTropes?.() || []);
    if(tropes.length){
      const t = tropes[0]
        .replace(/\(.*?\)/g,"")
        .replace(/\s+/g," ")
        .trim();
      return clampText(t.toUpperCase(), maxLen);
    }
    // if no tropes selected, fallback to auto
  }

  // 5) Auto (smart): Title -> Trope -> Genre -> Vitals
  const manualTitle = (v("titleText") || "").trim();
  if(manualTitle) return clampText(manualTitle.toUpperCase(), maxLen);

  const tropes = (selectedTropes?.() || []);
  if(tropes.length){
    const t = tropes[0]
      .replace(/\(.*?\)/g,"")
      .replace(/\s+/g," ")
      .trim();
    return clampText(t.toUpperCase(), maxLen);
  }

  const g = (v("genreTone") || "").trim();
  if(g) return clampText(g.replaceAll("_"," ").toUpperCase(), maxLen);

  const examples = rules?.screenExamples || ["120/80","SYS 120 / DIA 80","PULSE 72","BPM 78"];
  return clampText(pick(examples), maxLen);
}
    function showToast(msg){
      const t = $("toast");
      if(!t) return;
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1100);
    }
    function setStatus(msg){
      const p = $("statusPill");
      if(p) p.textContent = msg;
    }
    const rndInt = (n)=>Math.floor(Math.random()*n);
    const pick = (arr)=>arr[rndInt(arr.length)];
    const uniq = (arr)=>Array.from(new Set(arr));
    const shuffle = (arr)=>[...arr].sort(()=>Math.random()-0.5);

    // ---------- Variations ----------
    const VARIATIONS = {
      bold_vector: "bold vector sticker, thick clean lines, high-contrast shapes, sharp vector clarity, premium sticker look",
      cute_clipart: "cute flat vector clipart sticker, rounded shapes, clean flat shading, crisp edges, commercial clipart style",
      hand_drawn: "hand-drawn illustration sticker style, inked outlines, slightly imperfect strokes, hand-rendered shading, trendy modern doodle realism, still crisp and sticker-ready",
      hand_doodle: "hand-drawn doodle sticker style, thick outline, simple flat shading, charming imperfections (but clean)",
      booktok_pop: "booktok pop-art sticker style, bold shapes, punchy contrast, crisp outlines",
      noir_minimal: "noir minimal sticker, simple shapes, limited details, strong contrast, modern minimal icon",
      neon_noir: "neon noir sticker, subtle neon glow accents, dark subject, high contrast highlights",
      luxury_editorial: "luxury editorial sticker aesthetic, polished highlights, premium glam details, clean upscale feel",
      vintage_label: "vintage apothecary label sticker style, ornate frame details, bold readable label text (still clean)",
      kawaii_goth: "kawaii goth sticker style, cute + dark contrast, tiny hearts, subtle spooky accents, clean vector finish"
    };

    // ---------- Palettes ----------
    const PALETTES = [
      // Horror-friendly / red-black heavy
      "Blood Red + Ink Black + Bone",
      "Red + Black + Cream",
      "Oxblood + Black + Smoke Gray",
      "Black Cherry + Gunmetal + Chrome",
      "Black + Ruby + Liquid Silver",
      "Grey + Red + Black",
      "Copper + Black + Ember Glow",

      // Luxe / neutral
      "Cream + Warm Brown + Gold",
      "Ivory + Espresso + Rose Gold",
      "Blush Pink + Cocoa + Cream",
      "Rose Gold + Mauve + Champagne",
      "Dusty Rose + Mocha + Gold",
      "Burgundy Wine + Antique Gold + Espresso",
      "Obsidian + Molten Gold + Smoke Gray",

      // Fantasy / paranormals
      "Deep Plum + Rose Gold + Charcoal",
      "Amethyst + Midnight + Silver",
      "Teal + Obsidian + Violet Glow",
      "Forest Green + Black + Moonlight Silver",
      "Galaxy Blue + Violet + Star White",
      "Midnight Blue + Emerald + Gold",

      // Fun neon
      "Neon Pink + Black + Chrome",
      "Electric Blue + Hot Pink + Black",
      "Acid Green + Black + Silver",
      "Metallic Silver + Bubblegum + Black",
      "Aqua + Deep Purple + Neon Yellow",
      "Tangerine + Purple + White"
    ];

    function loadPalettes(){
      const sel = $("palette");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "None";
      sel.appendChild(opt0);
      PALETTES.forEach(p=>{
        const o=document.createElement("option");
        o.value=p; o.textContent=p;
        sel.appendChild(o);
      });
    }

    // ---------- Product catalog ----------
    const PRODUCT_DESC = {
      // Medical / pharma
      iv_bag: "IV drip bag sticker illustration (generic medical bag shape), hanging with tube, clamp, drip chamber, glossy liquid fill; clean label panel area for text; no hospital branding",
      pill_bottle: "prescription bottle sticker (amber bottle with childproof cap), clean warning label panel; a few stylized pills nearby; no pharmacy branding",
      prescription_pad: "prescription pad / Rx notepad sticker with tear-off sheets; clean header blocks; no clinic branding",
      specimen_vial: "lab specimen vial sticker (generic sample tube) with sparkly 'evidence' inside; clean label panel; no lab branding",
      elixir_dropper: "love potion / elixir dropper bottle sticker (glass dropper, glossy liquid), clean label panel; no branding",
      blood_pressure: "blood pressure monitor sticker (digital cuff display or compact monitor), clean screen area for text; no medical brand",
      heart_monitor: "heartbeat monitor screen sticker (ECG waveform on a small screen), clean label panel; readable UI-like display but NOT an app screenshot",

      // Tags / receipts / cards
      library_card: "library card / checkout slip sticker (classic library card layout with lines and stamps), clean typography blocks, no real library name",
      guest_check: "guest check receipt sticker (restaurant guest check layout: table, guests, server, check number), clean grid, no real restaurant branding",
      tbr_receipt: "store receipt sticker (TBR receipt aesthetic), itemized lines and totals, bold funny headers, no real store branding",
      evidence_tag: "evidence tag + barcode label sticker (toe-tag cousin, cleaner/cuter), string loop, barcode blocks, no real case identifiers",
      confession_note: "confession note sticker with header 'CONFESSION:' and a bold handwritten quote; cute dramatic vibe; clean paper edges",
      sticky_memo: "sticky memo note sticker stack (2–3 sticky notes), handwritten vibe, clean edges, minimal desk icons",
      name_tag: "name tag sticker (HELLO, I AM...) with bold writable area; cute event badge style; no brand",
      door_tag: "door tag sticker (hotel-style do not disturb), bold text area; no hotel branding",

      // Meters / scales / signs
      delulu_meter: "delulu meter sticker with labeled levels and a slider indicator; cute + cocky vibe; centered composition",
      spice_scale: "spice scale sticker (thermometer or gauge with labeled levels), playful heat; centered composition",
      caution_sign: "caution sign sticker (warning icon + bold headline), romance/spice coded; clean readable blocks",

      // Witchy / bookish objects
      wax_seal: "wax seal stamp kit sticker (wax seal stamp, wax beads, small seal impression), luxe witchy vibe; no brand marks",
      spell_candle: "candle jar / spell candle sticker (glass jar candle with label panel, subtle wax drips), cozy witchy, no brand",
      tarot_pack: "tarot card pack sticker (stack of tarot cards + one face card shown), mystical but modern, no copyrighted decks",
      fortune_cookie: "fortune cookie sticker (cookie cracked open with a fortune strip), cute bold vibe",
      magic_8_ball: "magic 8 ball sticker (classic ball shape), bold answer window (no trademarked phrases), modern clean",
      glass_fortune_ball: "glass fortune ball sticker (crystal ball on a stand), subtle sparkles contained inside silhouette",

      // Lifestyle
      matchbook: "matchbook / matchbox sticker with bold label panel; a few matches; no brand",
      polaroid_frame: "polaroid photo frame sticker (blank photo window + caption strip), cute modern scrapbooking vibe",
      nail_polish: "nail polish bottle sticker (glossy bottle, clean label panel), glam reader vibe, no brand",
      coffee_cup: "coffee / iced coffee / tea cup sticker (to-go cup or clear iced cup), cozy urban cafe vibe, no brand",
      phone_dnd: "phone screen sticker showing 'DND' / 'Do Not Disturb' style message, clean minimal, NOT a real OS screenshot",

      // Bookish
      book_stack: "stack of books sticker (3–5 books), bold shapes, cute details, clean edges",
      bookmark_sneakerlace: "bookmark + sneaker lace combo sticker (bookmark tied like a lace, street-bookish mashup), wildly original",
      book_review_card: "book review card sticker (rating layout with stars, short review text blocks), no real book titles"
    };

    // Product categories to fix your “FDA subtitle on meters” issue
    const PRODUCT_CATEGORY = {
      iv_bag: "medical",
      pill_bottle: "medical",
      prescription_pad: "medical",
      specimen_vial: "medical",
      elixir_dropper: "medical",
      blood_pressure: "medical",
      heart_monitor: "medical",

      evidence_tag: "casefile",
      guest_check: "receipt",
      tbr_receipt: "receipt",
      library_card: "receipt",
      confession_note: "note",
      sticky_memo: "note",
      name_tag: "tag",
      door_tag: "tag",

      delulu_meter: "meter",
      spice_scale: "meter",
      caution_sign: "sign",

      wax_seal: "witchy",
      spell_candle: "witchy",
      tarot_pack: "witchy",
      fortune_cookie: "fortune",
      magic_8_ball: "fortune",
      glass_fortune_ball: "fortune",

      matchbook: "lifestyle",
      polaroid_frame: "lifestyle",
      nail_polish: "lifestyle",
      coffee_cup: "lifestyle",
      phone_dnd: "lifestyle",

      book_stack: "bookish",
      bookmark_sneakerlace: "bookish",
      book_review_card: "review"
    };

    function describeProductKey(){
      const custom = (v("customProductTheme")||"").trim();
      if(custom) return custom;
      const k = v("productTheme");
      if(!k) return "";
      return PRODUCT_DESC[k] || `packaging-style sticker illustration of ${k.replaceAll("_"," ")} with clean label panel`;
    }

    function productCategory(){
      const k = v("productTheme");
      if(!k) return "default";
      return PRODUCT_CATEGORY[k] || "default";
    }

    // ---------- Label titles ----------
    const LABEL_TITLES = {
      // meters/scales/signs
      delulu_meter: ["DELULU METER","OBSESSION METER","DEVOTION METER","CHAOS METER","VIBES METER"],
      spice_scale: ["SPICE SCALE","HEAT CHECK","FLIRT THERMOMETER","CHEMISTRY GAUGE","TEMPTATION SCALE"],
      caution_sign: ["CAUTION","WARNING","NOTICE","ALERT","HANDLE WITH CARE"],

      // receipts/cards/tags/notes
      guest_check: ["GUEST CHECK","DINNER DATE RECEIPT","BOOKSTORE DATE CHECK","TAB OPEN","CHECK PLEASE"],
      tbr_receipt: ["TBR RECEIPT","ONE MORE BOOK","READING RUN","PAYMENT: PEACE","TOTAL: CHAOS"],
      library_card: ["LIBRARY CARD","CHECKOUT SLIP","DUE DATE DRAMA","BOOKLAND PASS","LOAN RECORD"],
      evidence_tag: ["EVIDENCE TAG","CASE LABEL","EXHIBIT A","PROOF OF FEELINGS","BARCODED CHAOS"],
      confession_note: ["CONFESSION","CONFESSIONS","A NOTE","PSA","LISTEN..."],
      sticky_memo: ["NOTE TO SELF","REMINDER","STICKY NOTE","READING NOTE","TO-DO (NOT REALLY)"],
      name_tag: ["HELLO, I AM","NAME TAG","INTRO","BADGE","IDENTITY CHECK"],
      door_tag: ["DO NOT DISTURB","DND","DO NOT ENTER","BUSY","NOT AVAILABLE"],

      // medical/pharma
      iv_bag: ["OBSESSION INFUSION","HEARTBREAK RECOVERY","SOFT LIFE TRANSFUSION","MAIN CHARACTER SERUM","MIDNIGHT DRIP"],
      pill_bottle: ["MORALLY GREY CAPSULES","DELULU SUPPORT PILLS","UNHINGED MMC TABLETS","TBR CONTROL MEDS","CHAOS & CHEMISTRY RX"],
      prescription_pad: ["PRESCRIPTION","RX","DOCTOR'S ORDERS","SCRIPT","TREATMENT PLAN"],
      specimen_vial: ["SPECIMEN","EVIDENCE VIAL","SAMPLE: CHEMISTRY","LAB RESULTS","SEALED SAMPLE"],
      elixir_dropper: ["LOVE POTION","ELIXIR","DEVOTION DROPS","MIDNIGHT MIX","SPELL SERUM"],
      blood_pressure: ["PRESSURE CHECK","HEART RATE ALERT","STRESS MONITOR","VITALS","READING RESPONSE"],
      heart_monitor: ["HEARTBEAT","PULSE CHECK","STATUS: SPIKE","ECG ALERT","CHEMISTRY SIGNAL"],

      // witchy / fortune
      wax_seal: ["SEALED","WAX SEAL","PRIVATE","CONFIDENTIAL","STAMPED"],
      spell_candle: ["SPELL CANDLE","INTENTION","MANIFEST","WARDS UP","BLESSED BURN"],
      tarot_pack: ["TAROT PULL","CARD READING","THE MESSAGE","DIVINATION","FATE CHECK"],
      fortune_cookie: ["FORTUNE","GOOD NEWS","MESSAGE","PROPHECY","LUCK"],
      magic_8_ball: ["ASK AGAIN","THE ANSWER","8 BALL SAYS","VERDICT","CONSULTED"],
      glass_fortune_ball: ["CRYSTAL BALL","VISION","FORETOLD","SEEN","REVEALED"],

      // lifestyle/bookish/review
      matchbook: ["IGNITE ME","BURN AFTER READING","MATCHES","SPARK","LIT"],
      polaroid_frame: ["SNAPSHOT","MEMORY","PHOTO MOMENT","CAPTURED","POLAROID"],
      nail_polish: ["GLOSS","POLISH","NAIL ENERGY","FRESH SET","SHINE"],
      coffee_cup: ["CAFFEINATED","CAFÉ RUN","ICED & UNBOTHERED","COFFEE DATE","SIP & READ"],
      phone_dnd: ["DND","DO NOT DISTURB","AIRPLANE MODE","SILENT MODE","BUSY"],
      book_stack: ["STACKED","BOOK PILE","TBR STACK","CHAPTERS","SHELF LIFE"],
      bookmark_sneakerlace: ["BOOKMARK","LACE LOCK","PAGE HOLDER","STREET READS","BOOK DRIP"],
      book_review_card: ["BOOK REVIEW","RATING","VERDICT","FINAL THOUGHTS","REVIEW CARD"],

      default: ["MAIN CHARACTER ENERGY","PLOT TWIST PENDING","SOFT LIFE LOADING","LUXURY LOVE ONLY","CITY-LIT CHAOS","GREY AREA ONLY"]
    };

    // ---------- Label subtitles (category-based to avoid mismatches) ----------
    const LABEL_SUBS = {
      // medical/pharma gets FDA-ish lines
      medical: [
        "Not FDA approved (but effective).",
        "Side effects: possessive behavior.",
        "Dosage: one more chapter.",
        "Warning: may cause delulu.",
        "Take at bedtime: results immediate.",
        "Do not mix with breadcrumbs."
      ],

      // meters/scales get meter-appropriate lines
      meter: [
        "Slide to your current level.",
        "Current status: down bad.",
        "Reality check: unavailable.",
        "Do not reset me.",
        "Handle with care: intense.",
        "Calibration: morally grey."
      ],

      // receipts/cards
      receipt: [
        "Total: one more chapter.",
        "Payment method: peace & quiet.",
        "Tip: mind your business.",
        "Return policy: no refunds.",
        "Due date: never.",
        "Thank you, come again."
      ],

      // casefile/evidence
      casefile: [
        "Case status: open.",
        "Exhibit A: chemistry.",
        "Evidence: texts too sweet.",
        "Suspect: too charming.",
        "Motive: obsession.",
        "Filed under: chaos."
      ],

      // tags
      tag: [
        "Approach with respect.",
        "Not accepting nonsense.",
        "Handle correctly.",
        "Read first, talk later.",
        "Entry: denied.",
        "Soft voice, strong no."
      ],

      // notes
      note: [
        "Read this again.",
        "No further questions.",
        "That’s the note.",
        "Clocked & noted.",
        "Say less.",
        "Respectfully… no."
      ],

      // signs
      sign: [
        "Proceed at your own risk.",
        "Warning: chemistry ahead.",
        "Caution: feelings detected.",
        "Do not disturb the peace.",
        "High heat zone.",
        "Authorized readers only."
      ],

      // witchy
      witchy: [
        "Sealed with intention.",
        "Wards up, standards higher.",
        "Moonlit and protected.",
        "Do not break the seal.",
        "Blessed and unbothered.",
        "Coven-approved."
      ],

      // fortune
      fortune: [
        "The answer is: absolutely.",
        "Ask again after midnight.",
        "Signs point to: obsessed.",
        "Outcome: inevitable.",
        "Prediction: you’ll re-read.",
        "Message received."
      ],

      // lifestyle
      lifestyle: [
        "Busy being iconic.",
        "Unavailable by choice.",
        "Energy: expensive.",
        "Handle with confidence.",
        "Read it and relax.",
        "Keep it cute."
      ],

      // review cards
      review: [
        "This book ruined me… 5 stars.",
        "Ugly cry… 5 stars.",
        "DBE: certified… 5 stars.",
        "I fear I loved it… 5 stars.",
        "Unwell… 5 stars.",
        "Would suffer again… 5 stars."
      ],

      // fallback
      default: [
        "99% Delulu • 1% Regret",
        "Results: immediate butterflies.",
        "Warning: plot twist pending.",
        "Handle with care.",
        "Luxury love only.",
        "Keep it cute."
      ]
    };

    function subtitleSetKey(){
      // Genre can influence a little, but category is the main fix.
      const cat = productCategory();
      return LABEL_SUBS[cat] ? cat : "default";
    }

    function getAutoLabel(){
      const productKey = v("productTheme") || "default";
      const titles = LABEL_TITLES[productKey] || LABEL_TITLES.default;
      const subs = LABEL_SUBS[subtitleSetKey()] || LABEL_SUBS.default;
      return { title: pick(titles), subtitle: pick(subs) };
    }

    // ---------- Quote banks ----------
    const MICRO_QUOTES = [
      "Final Chapter Energy","Airplane Mode Activated","Kindle Confidential","TBR Supreme","Booktrovert Vibes",
      "Certified Delulu","Plot Twist Pending","Morals Optional","Grace With Teeth","Stand On Business",
      "No Face No Case","Energy Expensive","Act Right Only","Handle Correctly","Possessive Energy Only",
      "Soft But Savage","Pretty With Power","Reader In Charge","Do Not Disturb","Main Character Mood",
      "Remaining in Bookland","Down Bad","Say Less","Clocked & Noted"
    ];

    const QUOTE_BANKS = {
      // CORE
      general_urban_bookish: [
        "Booked, Busy, Unavailable.","Reading Is My Love Language.","Respectfully, I’m In A Chapter.","If I Reply Late, Blame The Plot.",
        "I’m Not Ignoring You—The MMC Is.","My Peace Got Page Numbers.","Fictional Standards Only.","Text Me After The Epilogue.",
        "I Read That… Don’t Ask Questions.","Keep It Cute, I’m Reading.","I Don’t Chase— I Turn Pages.","Plot Thickening, Don’t Call.",
        "I’m Outside… In My Kindle.","Soft Life, Sharp Tongue.","I’m Sweet—Until The Plot Twists."
      ],
      tbr_kindle_booktok: [
        "My Kindle Know My Business.","My TBR Is A Lifestyle.","BookTok Made Me Do It.","Kindle History Stays Private.",
        "One More Chapter Is A Lie.","I’m In My Re-Read Era.","I Buy Books Like It’s Therapy.","My TBR Got A Mortgage.",
        "My Kindle Is The Side Piece.","I’m Booked Through Next Week.","I DNF People Too.","Shelf Control Issues."
      ],
      morally_gray: [
        "If He’s Wrong, I’m Worse.","Grace With Teeth.","Morals? Negotiable.","Pretty. Petty. Precise.","I’m Not Nice. I’m Necessary.",
        "Charm Is Tactical.","Mercy Is Optional.","I Play Long Games.","Soft Voice. Hard Consequences."
      ],
      unhinged_mmc: [
        "He’s Unstable. I’m Interested.","Mine. No Discussion.","Obsessed Is Romantic.","Touch Me & See.","He Doesn’t Share.",
        "Protective Looks Good.","He’d Burn Cities For Me.","Red Flags Are Decorative.","He’s Calm. Until It’s Me."
      ],
      street_lingo: [
        "Stand On Business.","Ten Toes. No Folding.","Don’t Play In My Face.","Clocked & Noted.","Say Less.",
        "Keep It Cute Or Keep It Moving.","Energy Expensive.","No Face. No Case.","Silent Moves. Loud Results."
      ],

      // NEW: Your “Mood quotes” list → belongs in quote banks
      mood_quotes: [
        "Remaining in Bookland until further notice.",
        "This book ruined me… 5 stars.",
        "Ugly cry… 5 stars.",
        "In my “___” era.",
        "DBE: ___ … 5 stars.",
        "Me + “whoever” go together real bad.",
        "I love “whatever” real bad.",
        "STFUATTDLAGG — and make it spicy."
      ],

      // NEW: IYKYK bank
      iykyk: [
        "If you know, you know.",
        "The girls that get it, get it.",
        "Don’t explain it to them.",
        "I said what I said.",
        "Read between the lines.",
        "This is for the real readers.",
        "Clock that.",
        "Not for the weak."
      ],

      // NEW: Audiobook-coded
      audiobook: [
        "If the narrator snaps, I fold.",
        "Narrator voice got me acting unwise.",
        "Audiobook me, respectfully.",
        "Headphones in, morals out.",
        "That voice? Criminal.",
        "If he growls, it’s over.",
        "I replayed that chapter. Mind your business."
      ],

      // GENRE FLAVORS
      urban_fiction: [
        "Ride Or Die Reads.","Love Loud. Move Quiet.","City-Lit Chemistry.","I Like My Plots Like My Streets—Dangerous.",
        "Pressure Make Diamonds.","Hood Luxe, Soft Hands.","Don’t Fold On The Feelings.","I like it loud and loyal."
      ],
      black_romance: [
        "Soft Love, Strong Boundaries.","Luxury Love Only.","Healed, But Still Don’t Try Me.","Love Me Correctly.",
        "Black Love, Big Energy.","Peace First, Passion Second.","Gentle love, heavy devotion."
      ],
      dark_romance: [
        "Sweet… Until Midnight.","Danger Looks Good.","Tension Got A Grip On Me.","Bad Decisions, Great Chemistry.",
        "He’s A Problem. I’m Invested.","I Like It Dark And Devoted.","He’s toxic. I’m literate."
      ],
      black_paranormal: [
        "Ancestral Power Activated.","Moonlit & Dangerous.","My Aura Don’t Argue.","Spirit-Safe, But Still Spicy.",
        "Wards Up, Standards Higher.","Coven Chic Only.","Do not invite him in."
      ],
      thriller: [
        "Trust No One.","Hidden In Plain Sight.","Smile. It’s Recorded.","Cold Case Energy.","Observe. Then Strike.",
        "Nothing Is Random.","Keep Your Eyes Open.","I’m suspicious by default."
      ],
      horror: [
        "Don’t go in that room.","The vibe is cursed.","I heard a noise… nope.","It’s giving… final girl.",
        "I should’ve DNF’d the house.","If you see me running, run too.","This chapter is possessed."
      ],
      fantasy: [
        "Spellbound & Sealed.","Summon At Midnight.","Divine & Dangerous.","Enchanted, Not Explained.",
        "Cursed In A Cute Way.","Fae Rules, My Terms.","Magic made me do it."
      ],
      bookish_luxe: [
        "Glossy Covers, Expensive Taste.","Quiet Luxury, Loud Standards.","Polished & Petty.","Champagne Chapters Only.",
        "Reader, But Make It Luxury.","Old money, new obsession."
      ],
      soft_glam_reader: [
        "Soft Glam, Sharp Mind.","Pretty Pages Only.","Cozy But Don’t Test Me.","Lip Gloss & Literature.",
        "Sweet Voice, Strong No.","Soft life, firm boundaries."
      ]
    };

    function customQuoteBank(){
      const raw = (v("customQuotes")||"").trim();
      if(!raw) return [];
      return raw.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    }

    function selectedGenreBanks(){
      const map = [
        ["gUrbanFiction","urban_fiction"],
        ["gBlackRomance","black_romance"],
        ["gDarkRomance","dark_romance"],
        ["gBlackParanormal","black_paranormal"],
        ["gThriller","thriller"],
        ["gHorror","horror"],
        ["gFantasy","fantasy"],
        ["gBookishLuxe","bookish_luxe"],
        ["gSoftGlam","soft_glam_reader"]
      ];
      return map.filter(([id])=>c(id)).map(([,k])=>k);
    }

    function buildQuotePool(){
      // 1) Custom wins
      const custom = customQuoteBank();
      if(custom.length) return custom;

      let pool = [];
      // core
      if(c("bGeneralUrbanBookish")) pool.push(...(QUOTE_BANKS.general_urban_bookish||[]));
      if(c("bTBRKindleBooktok")) pool.push(...(QUOTE_BANKS.tbr_kindle_booktok||[]));
      if(c("bMorallyGray")) pool.push(...(QUOTE_BANKS.morally_gray||[]));
      if(c("bUnhingedMMC")) pool.push(...(QUOTE_BANKS.unhinged_mmc||[]));
      if(c("bStreetLingo")) pool.push(...(QUOTE_BANKS.street_lingo||[]));
      if(c("bMoodQuotes")) pool.push(...(QUOTE_BANKS.mood_quotes||[]));
      if(c("bIYKYK")) pool.push(...(QUOTE_BANKS.iykyk||[]));
      if(c("bAudiobook")) pool.push(...(QUOTE_BANKS.audiobook||[]));

      // genre flavors
      selectedGenreBanks().forEach(key=> pool.push(...(QUOTE_BANKS[key]||[])));

      // mode adds micro
      const qm = v("quoteMode");
      if(qm === "micro" || qm === "any") pool.push(...MICRO_QUOTES);

      pool = uniq(pool);
      if(pool.length===0) pool = uniq([...(QUOTE_BANKS.general_urban_bookish||[]), ...(QUOTE_BANKS.mood_quotes||[]), ...MICRO_QUOTES]);

      if(qm==="micro"){
        const micro = uniq([...MICRO_QUOTES]);
        return micro.length ? micro : pool;
      }
      return pool;
    }

    function chooseQuote(){
      const typed = (v("quote")||"").trim();
      if(typed) return typed;
      if(!c("useRandomQuote")) return "";
      const pool = buildQuotePool();
      return pool.length ? pick(pool) : "";
    }

    // ---------- Tropes ----------
    const TROPE_LABELS = {
      tWealthyMMC: "wealthy MMC / billionaire energy",
      tAgeGap: "age-gap romance trope",
      tStepDaddyMMC: "step-daddy MMC (he steps up as ideal father figure)",
      tEnemiesToLovers: "enemies-to-lovers trope",
      tFriendsToLovers: "friends-to-lovers trope",
      tForcedProximity: "forced proximity trope",
      tFakeDating: "fake dating trope",
      tSecondChance: "second-chance romance trope",
      tForbiddenRomance: "forbidden romance trope",
      tSecretBaby: "secret baby trope",
      tMarriageConvenience: "marriage of convenience trope",
      tBossAssistant: "boss/assistant trope",
      tBodyguard: "protector/bodyguard trope",
      tWhoDidThis: "“who did this to you?” moment trope",
      tTouchHerDie: "“touch her and die” protective trope",
      tBlackCatGolden: "black cat FMC × golden retriever MMC trope",
      tReverseHarem: "reverse harem trope",
      tMMF: "MMF trope",
      tMFM: "MFM trope",
      tMMFMM: "MMFMM trope",
      tMMMF: "MMMF trope"
    };

    const TROPE_IDS = Object.keys(TROPE_LABELS);

    function selectedTropes(){
      return TROPE_IDS.filter(id=>c(id)).map(id=>TROPE_LABELS[id]);
    }

    // ---------- Typography / spice ----------
    function typographyRuleText(){
      if(v("typoRule") !== "on") return "";
      return "clear legible typography, centered composition, bold high-contrast text, no distorted letters";
    }
    function spiceAesthetic(){
      const s = Number(v("spiceLevel") || 1);
      if(s<=1) return "spice aesthetic: sweet tension, soft charm, cozy flirt energy";
      if(s===2) return "spice aesthetic: playful chemistry, cheeky tension, cute-but-bold";
      if(s===3) return "spice aesthetic: spicy vibes, bold flirting, possessive undertones (non-graphic)";
      if(s===4) return "spice aesthetic: dark romance heat, intense chemistry, edgy tension (non-graphic)";
      return "spice aesthetic: filthy talk energy, power tension, ruthless chemistry (non-graphic)";
    }

    // ---------- Cut-safe instruction (applies to ALL accents) ----------
    function cutSafeText(){
      if(!c("cutSafeMode")) return "";
      return [
        "Cut-safe die-cut requirement: one continuous closed silhouette outline around the ENTIRE design.",
        "ABSOLUTE RULE: every sparkle, glitter dot, foil fleck, smoke wisp, particle, shine pop, and glow must be INSIDE the silhouette boundary.",
        "No floating elements outside the border. No stray dots. No outside specks. No outside aura. No outer shadow.",
        "Any glow must hug the silhouette tightly and remain fully inside the die-cut outline.",
        "If any particles would cross the edge, remove them."
      ].join(" ");
    }
    function accentContainmentSuffix(){
      if(!c("cutSafeMode")) return "";
      return "(ALL accents/particles/glow fully contained INSIDE the silhouette; nothing outside the outline; no stray dots)";
    }

    // ---------- Visual finish ----------
    function finishText(){
      const outline = (v("outline")==="bold_black") ? "thick bold outline" : "no outline";
      const border = (v("border")==="white") ? "clean white sticker offset border" : "no sticker border";
      const bgMode = v("bgMode");
      const bg =
        (bgMode==="transparent") ? "transparent background" :
        (bgMode==="solid_white") ? "solid white background" : "background not specified";

      let varKey = v("variation");
      if(c("handDrawnPreset")) varKey = "hand_drawn";
      const varText = varKey ? (VARIATIONS[varKey] || "") : "";

      const handDrawnExtra = c("handDrawnPreset")
        ? "hand-drawn rule: keep lines organic and inked, slight wobble allowed, but edges must remain crisp and print-ready"
        : "";

      return [
        outline, border, bg,
        varText,
        handDrawnExtra,
        "bold shapes, punchy contrast",
        "crisp outlines, crisp edges, vector-like clarity",
        "high resolution",
        "no brand logos, no watermark"
      ].filter(Boolean).join(", ");
    }

    // ---------- Smart harmony rules ----------
    const HORROR_PALETTE_DEFAULT = "Blood Red + Ink Black + Bone";

    function setVIfDiff(id, val){
  const el = $(id);
  if(!el) return false;
  if(String(el.value) === String(val)) return false;
  el.value = val;
  return true;
}
    const HORROR_PALETTE_DEFAULT = "Blood Red + Ink Black + Bone";

function applyHarmonyRules(){
  // Harmony should ONLY set values / show notes.
  // It should NOT call generate().

  const genre = (v("genreTone") || "").trim();
  const horrorToggle = c("gHorror");          // if you have this checkbox
  const handDrawnOn = c("handDrawnPreset");   // if you added this toggle

  const customPalette = (v("customPalette") || "").trim();
  const paletteSel = (v("palette") || "").trim();

  const harmonyBox = $("harmonyNote");

  // --- 1) Hand-drawn preset: force variation to hand_drawn (only if different)
  if(handDrawnOn){
    setVIfDiff("variation", "hand_drawn");
  }

  // --- 2) Horror palette rule (genre OR toggle turns it on)
  const horrorActive = (genre === "horror") || horrorToggle;

  if(horrorActive && !customPalette){
    // If palette is empty or not already red/black leaning, set it.
    const looksHorror =
      paletteSel.toLowerCase().includes("blood") ||
      paletteSel.toLowerCase().includes("red") ||
      paletteSel.toLowerCase().includes("black") ||
      paletteSel.toLowerCase().includes("ink");

    if(!paletteSel || !looksHorror){
      const changed = setVIfDiff("palette", HORROR_PALETTE_DEFAULT);
      if(changed && harmonyBox){
        harmonyBox.style.display = "";
        harmonyBox.innerHTML = `<b>Harmony:</b> Horror detected → palette auto-set to <b>${HORROR_PALETTE_DEFAULT}</b> (clear Custom Palette to keep auto-pairing).`;
      }
      return; // stop here so we don’t overwrite other harmony notes
    }
  }

  // --- 3) Otherwise hide note
  if(harmonyBox){
    harmonyBox.style.display = "none";
    harmonyBox.innerHTML = "";
  }
}

    // ---------- Subject / label logic ----------
    function shouldIncludeQuoteLine(stickerType){
      const usage = v("quoteUsage"); // smart|always|never
      if(c("blankMode")) return false;
      if(usage === "never") return false;
      if(usage === "always") return true;

      if(stickerType === "icon_quote") return true;
      if(stickerType === "quote_only") return true;
      if(stickerType === "packaging") return false; // packaging keeps label clean by default
      return false;
    }

    function genreToneText(){
      const g = v("genreTone");
      if(!g) return "";
      return "genre tone: " + g.replaceAll("_"," ") + ".";
    }

    function vibeText(){
      const custom = (v("customVibe")||"").trim();
      const base = v("vibe");
      const vv = custom || base;
      return vv ? ("vibe: " + vv + ".") : "";
    }

    function paletteText(){
      const custom = (v("customPalette")||"").trim();
      const base = v("palette");
      const p = custom || base;
      return p ? ("color palette: " + p + ".") : "";
    }

    function tropesText(){
      const list = selectedTropes();
      if(!list.length) return "";
      return "tropes: " + list.join("; ") + ".";
    }

    function buildLabelTextBlock(stickerType, quote){
      if(c("blankMode")) return "No label text.";
      const mode = v("labelMode"); // none|auto|manual|mixed|quote_subtitle
      if(mode === "none") return "No label text.";

      const hasProduct = !!describeProductKey();
      if(stickerType !== "packaging" && !hasProduct) return "";

      const manualTitle = (v("titleText")||"").trim();
      const manualSub = (v("subtitleText")||"").trim();

      const auto = getAutoLabel();

      const title = (mode==="manual") ? manualTitle :
                    (mode==="mixed") ? (manualTitle || auto.title) :
                    (mode==="quote_subtitle") ? (auto.title) :
                    (auto.title);

      const subtitle = (mode==="manual") ? manualSub :
                       (mode==="mixed") ? (manualSub || auto.subtitle) :
                       (mode==="quote_subtitle") ? (quote || auto.subtitle) :
                       (auto.subtitle);

      if(mode==="manual" && !title && !subtitle) return "No label text.";

      return `Label text (packaging-style): title “${title}”${subtitle ? `, subtitle “${subtitle}”` : ""}.`;
    }

    function mainSubjectText(){
      const customObj = (v("customMainObject")||"").trim();
      const product = describeProductKey();
      const stickerType = v("stickerType");

      if(stickerType === "packaging" || product){
        return `Main subject: ${product || "packaging-style sticker illustration with clean label panel"}` + (customObj ? `, featuring ${customObj}` : "") + ".";
      }

      if(customObj) return `Main subject: ${customObj}.`;
      return "Main subject: simple iconic bookish symbol.";
    }

    function accentsText(){
      const custom = (v("customAccents")||"").trim();
      if(!custom) return "";
      return `add accents: ${custom} ${accentContainmentSuffix()}.`;
    }

    function productThemeText(){
      const custom = (v("customProductTheme")||"").trim();
      const base = v("productTheme");
      const t = custom || (base ? base.replaceAll("_"," ") : "");
      return t ? ("Product theme: " + t + ".") : "Product theme: None.";
    }
    /* =========================
   PATCH: Monitor screen text + bottom quote banner
   (Drop-in: paste inside <script> after PRODUCT_DESC / PRODUCT_CATEGORY / LABEL_SUBS / LABEL_TITLES)
   ========================= */

// 1) Add/override: product-specific layout rules
const PRODUCT_LAYOUT_RULES = {
  blood_pressure: {
    screenPurpose: "Vitals display (e.g., 120/80, BPM, SYS/DIA labels) OR short Genre/Trope text",
    screenExamples: ["120/80", "118/76", "SYS 120 / DIA 80", "PULSE 72", "BPM 78"],
    screenTextMax: 14,
    bottomBannerPurpose: "Quote line (main quote goes here, centered, readable)",
  },
  heart_monitor: {
    screenPurpose: "Monitor display (ECG + numeric readouts) OR short Genre/Trope text",
    screenExamples: ["HR 72", "BPM 86", "SYS 120 / DIA 80", "URBAN FICTION", "AGE GAP"],
    screenTextMax: 14,
    bottomBannerPurpose: "Quote line (main quote goes here, centered, readable)",
  }
};

// 2) Helpers: pick screen text
function isMonitorProduct(){
  const k = v("productTheme");
  return k === "blood_pressure" || k === "heart_monitor";
}

function clampText(s, max){
  const t = (s||"").trim();
  if(!t) return "";
  if(t.length <= max) return t;
  return t.slice(0, max).trim();
}

// Prefer: if user typed a Title, use that as screen text for monitors (it’s usually “URBAN FICTION”, “AGE GAP”, etc.)
// Else: if tropes selected, use one trope label
// Else: use genre tone
// Else: use a vitals readout like 120/80 or HR/BPM
function screenTextForMonitor(){
  const k = v("productTheme");
  const rules = PRODUCT_LAYOUT_RULES?.[k] || {};
  const maxLen = rules?.screenTextMax ?? 18;

  const mode = screenMode();

  // If not a monitor product, return empty.
  if(!isMonitorProduct()) return "";

  // 1) Custom always wins
  if(mode === "custom"){
    const custom = (v("customScreenText") || "").trim();
    if(custom) return clampText(custom.toUpperCase(), maxLen);
  }

  // Helper picks
  const genreLabel = (()=>{
    const g = (v("genreTone") || "").replaceAll("_"," ").trim();
    if(!g) return "BOOKTROPE";
    // keep short + bold
    return g.toUpperCase().slice(0, 16);
  })();

  const tropeLabel = (()=>{
    const t = (v("trope") || "").trim();
    if(!t) return "SLOW BURN";
    return t.toUpperCase().slice(0, 16);
  })();

  // 2) Smart Auto
  if(mode === "auto"){
    // If user picked a trope, use it. If not, show vitals.
    if((v("trope") || "").trim()) return clampText(tropeLabel, maxLen);
    return "SYS 120 / DIA 80 / PULSE 72";
  }

  // 3) Vitals (stacked look requested)
  if(mode === "vitals"){
    return "SYS 120 / DIA 80 / PULSE 72";
  }

  // 4) Genre big text
  if(mode === "genre"){
    return clampText(genreLabel, maxLen);
  }

  // 5) Trope big text
  if(mode === "trope"){
    return clampText(tropeLabel, maxLen);
  }

  // Fallback
  return "SYS 120 / DIA 80 / PULSE 72";
}

// 3) Override/extend product descriptions so they *explicitly* request screen text + bottom banner quote
// (This ensures the model puts the right text in the right place.)
PRODUCT_DESC.blood_pressure =
  "blood pressure monitor sticker (cuff + monitor), big rectangular screen area. " +
  "REQUIRE: the SCREEN must display text/numbers (e.g., “120/80”, “SYS 120 / DIA 80”, “PULSE 72”, or short Genre/Trope text). " +
  "REQUIRE: bottom banner area for the QUOTE text (centered). No medical brand, no real device UI screenshot.";

PRODUCT_DESC.heart_monitor =
  "heartbeat monitor screen sticker (ECG waveform + small screen), big screen area. " +
  "REQUIRE: the SCREEN must display text/numbers (e.g., “HR 72”, “BPM 86”, “120/80”, or short Genre/Trope text). " +
  "REQUIRE: bottom banner area for the QUOTE text (centered). No medical brand, no real device UI screenshot.";

// 4) Make monitor products use category 'meter' (NOT medical) so subtitles don't become FDA-ish.
// If you already have PRODUCT_CATEGORY, override these keys:
PRODUCT_CATEGORY.blood_pressure = "meter";
PRODUCT_CATEGORY.heart_monitor  = "meter";

// 5) Add a monitor-specific label subtitle set (screen stats) so auto label supports the layout.
LABEL_SUBS.monitor_stats = [
  "SCREEN: display 120/80 + BPM.",
  "SCREEN: display SYS/DIA + PULSE.",
  "SCREEN: show Genre/Trope in big text.",
  "SCREEN: show HR/BPM readout.",
  "SCREEN: show 120/80 (clean, bold)."
];

// Replace subtitleSetKey() if present, or wrap it:
const _subtitleSetKey = (typeof subtitleSetKey === "function") ? subtitleSetKey : null;
function subtitleSetKey(){
  if(isMonitorProduct()) return "monitor_stats";
  // fallback to original behavior if it exists
  if(_subtitleSetKey) return _subtitleSetKey();
  // safe default if not
  const cat = productCategory();
  return LABEL_SUBS[cat] ? cat : "default";
}

// 6) Quote placement rule: for monitors, ALWAYS put the quote in the bottom banner.
// We'll inject a layout instruction + force quote inclusion for packaging too.
const _shouldIncludeQuoteLine = (typeof shouldIncludeQuoteLine === "function") ? shouldIncludeQuoteLine : null;
function shouldIncludeQuoteLine(stickerType){
  if(isMonitorProduct() && !c("blankMode")) return true; // always include quote for monitors
  return _shouldIncludeQuoteLine ? _shouldIncludeQuoteLine(stickerType) : (stickerType !== "packaging");
}

// 7) Add explicit layout block for monitors: screen text + bottom quote banner.
function monitorLayoutText(quote){
  if(!isMonitorProduct()) return "";
  const screen = screenTextForMonitor();
  return [
    "Layout rules (monitor sticker):",
    `- SCREEN text (top display): “${screen}”.`,
    `- BOTTOM BANNER text (quote area): “${quote || "___"}”.`,
    "- Do NOT put the quote on the screen.",
    "- Do NOT leave the screen blank."
  ].join(" ");
}

// 8) Patch buildPromptSingle to include the layout rules.
// If buildPromptSingle exists, wrap it; otherwise you can manually insert monitorLayoutText(quote) in your prompt assembly.
const _buildPromptSingle = (typeof buildPromptSingle === "function") ? buildPromptSingle : null;
function buildPromptSingle(){
  // If your file already defines buildPromptSingle, we replicate the core flow:
  // Use the existing one to build, then inject monitor rules near the end.
  if(_buildPromptSingle){
    // We need the quote value to inject; easiest: re-run chooseQuote() here.
    // This matches your generator behavior.
    const quote = chooseQuote();
    const base = _buildPromptSingle();

    // Inject rules right after "Main subject" if possible; fallback: append.
    const injection = " " + monitorLayoutText(quote) + " ";
    return base.includes("Main subject:")
      ? base.replace("Main subject:", "Main subject:") + injection
      : (base + injection);
  }

  // If no prior buildPromptSingle, you need to insert monitorLayoutText(quote) where you assemble prompts.
  throw new Error("buildPromptSingle not found. Paste the monitorLayoutText(quote) line into your prompt assembly.");
}
    
    // ---------- Prompt assembly ----------
    function buildPromptSingle(){

      const stickerType = v("stickerType");
      const quote = chooseQuote();
      const typo = typographyRuleText();
      const safety = "original design, no trademarks, no brand names, no copyrighted characters";

      const quoteLine = (quote && shouldIncludeQuoteLine(stickerType))
        ? `Optional quote line: “${quote}”.`
        : "";

      const labelTextBlock = buildLabelTextBlock(stickerType, quote);

      const labelPanelNote = (stickerType === "packaging" || v("productTheme") || (v("customProductTheme")||"").trim())
        ? "Include a clean label panel area for text, centered layout, readable hierarchy."
        : "";

      const cutSafe = cutSafeText();
      const blankLine = c("blankMode") ? "No text at all (blank sticker mode)." : "";

      return [
        "Create image:",
        finishText() + ".",
        cutSafe,
        paletteText(),
        genreToneText(),
        vibeText(),
        tropesText(),
        spiceAesthetic() + ".",
        productThemeText(),
        mainSubjectText(),
        accentsText(),
        typo ? ("Typography: " + typo + ".") : "",
        labelPanelNote,
        labelTextBlock,
        quoteLine,
        blankLine,
        safety + ".",
        "Clean commercial sticker clipart look, polished, readable, centered."
      ].filter(Boolean).join(" ");
    }

    function buildBundle(){
      const n = Math.max(1, Math.min(5, parseInt(v("count"),10) || 1));
      const out = [];
      for(let i=0;i<n;i++){
        out.push(`Prompt ${i+1}:\n${buildPromptSingle()}`);
      }

      const negative =
        "photorealistic, blurry, low-res, messy outline, uneven line weight, distorted letters, unreadable text, random extra words, watermark, signature, brand logos, copyrighted characters, celebrity likeness, real book titles, background scene, floating particles outside outline, aura outside silhouette, outer shadow, UI screenshot, app interface, OS UI";

      const notes =
`Export notes:
- Best: PNG
- Background: Transparent (recommended for stickers)
- Size: 2000–3000px

Cut-safe:
- When ON: forces a single closed die-cut silhouette + keeps ALL accents inside.

Smarter labels:
- Subtitles are category-based (medical vs meter vs receipts etc.), so “FDA” lines won’t appear on meters anymore.

Harmony:
- Horror → automatically uses a red/black palette unless you set Custom Palette.`;

      return { body: out.join("\n\n"), negative, notes };
    }

    function generate(){
    withUiLock(()=>{
    try{
      applyHarmonyRules(); // harmony runs ONCE safely here

      const { body, negative, notes } = buildBundle();
      setV("promptOut", body);
      setV("negOut", negative);
      setV("notesOut", notes);

      setStatus("Generated ✅");
      setTimeout(()=>setStatus("Ready"), 900);
    } catch(e){
      setV("promptOut", "❌ Generator error:\n" + (e?.message || e));
      setStatus("Error ❌");
      showToast("Error — check Prompt box");
    }
  });
}

    async function copyPrompt(){
      const text = (v("promptOut")||"").trim();
      if(!text){ showToast("Generate first"); return; }
      try{
        await navigator.clipboard.writeText(text);
        showToast("Copied");
      } catch{
        const ta = $("promptOut");
        ta.focus(); ta.select();
        document.execCommand("copy");
        showToast("Copied");
      }
    }

    // ---------- Randomize ----------
    const CORE_BANK_IDS = ["bGeneralUrbanBookish","bTBRKindleBooktok","bMorallyGray","bUnhingedMMC","bStreetLingo","bMoodQuotes","bIYKYK","bAudiobook"];
    const GENRE_BANK_IDS = ["gUrbanFiction","gBlackRomance","gDarkRomance","gBlackParanormal","gThriller","gHorror","gFantasy","gBookishLuxe","gSoftGlam"];
    const PRODUCT_KEYS = Object.keys(PRODUCT_DESC);

    function uncheckAll(ids){ ids.forEach(id=>{ if($(id)) $(id).checked = false; }); }

    function pickOneOrTwo(ids){
      uncheckAll(ids);
      const pickCount = Math.random() < 0.55 ? 1 : 2;
      const shuffled = shuffle(ids);
      shuffled.slice(0, pickCount).forEach(id=> setC(id,true));
    }

    function pickZeroToTwo(ids){
      uncheckAll(ids);
      const r = Math.random();
      const pickCount = (r<0.55) ? 0 : (r<0.85 ? 1 : 2);
      const shuffled = shuffle(ids);
      shuffled.slice(0, pickCount).forEach(id=> setC(id,true));
    }

    function randomize(){
      setV("count", String(pick(["1","2","3"])));
      setV("stickerType", pick(["packaging","icon_quote","icon_only","quote_only"]));

      setC("cutSafeMode", true);

      // genre tone
      setV("genreTone", pick(["urban_fiction","dark_romance","black_paranormal","black_romance","thriller","fantasy","horror","soft_glam_reader","bookish_luxe",""]));

      // vibes (keep Slow burn as vibe option)
      setV("vibe", pick(Array.from($("vibe").options).map(o=>o.value).filter(x=>x)));

      // hand drawn preset sometimes
      setC("handDrawnPreset", Math.random()<0.30);
      setV("variation", c("handDrawnPreset") ? "hand_drawn" : pick(["booktok_pop","bold_vector","luxury_editorial","neon_noir","noir_minimal","hand_doodle","cute_clipart","vintage_label","kawaii_goth",""]));

      // product theme (bias packaging)
      if(v("stickerType")==="packaging"){
        setV("productTheme", pick(PRODUCT_KEYS));
      } else {
        setV("productTheme", Math.random()<0.55 ? pick(PRODUCT_KEYS) : "");
      }

      // palette: harmony will correct horror if needed
      setV("palette", pick(["", ...PALETTES]));
      setV("bgMode", pick(["transparent","solid_white","transparent"]));

      setV("spiceLevel", pick(["1","2","3","4","5"]));
      setV("labelMode", v("stickerType")==="packaging" ? pick(["auto","mixed","none","quote_subtitle"]) : "none");
      setC("blankMode", v("stickerType")==="icon_only" ? (Math.random()<0.25) : false);

      // quote banks
      pickOneOrTwo(CORE_BANK_IDS);
      if(Math.random()<0.65) pickOneOrTwo(GENRE_BANK_IDS); else uncheckAll(GENRE_BANK_IDS);

      // tropes
      pickZeroToTwo(TROPE_IDS);

      setC("useRandomQuote", !c("blankMode"));

      // clear overrides
      setV("titleText","");
      setV("subtitleText","");
      setV("quote","");
      setV("customMainObject","");
      setV("customVibe","");
      setV("customPalette","");
      setV("customAccents","");
      setV("customProductTheme","");
      setV("customQuotes","");

      generate();
      showToast("Randomized (smart picks)");
    }

    function clearAll(){
      setV("count","3");
      setV("stickerType","packaging");
      setV("genreTone","");
      setV("variation","");
      setV("vibe","");
      setV("productTheme","");
      setV("palette","");
      setV("bgMode","transparent");
      setV("border","white");
      setV("outline","bold_black");
      setV("spiceLevel","2");
      setV("typoRule","on");

      setC("handDrawnPreset", false);
      setC("blankMode", false);
      setC("cutSafeMode", true);
      setV("labelMode","auto");

      setC("useRandomQuote", true);
      setV("quoteUsage","smart");
      setV("quote","");
      setV("titleText","");
      setV("subtitleText","");

      setV("customMainObject","");
      setV("customVibe","");
      setV("customPalette","");
      setV("customAccents","");
      setV("customProductTheme","");
      setV("customQuotes","");

      uncheckAll(CORE_BANK_IDS);
      setC("bGeneralUrbanBookish", true);
      setC("bMoodQuotes", true);
      setC("bIYKYK", true);

      uncheckAll(GENRE_BANK_IDS);
      uncheckAll(TROPE_IDS);

      setV("promptOut","");
      setV("negOut","");
      setV("notesOut","");

      const harmonyBox = $("harmonyNote");
      if(harmonyBox){ harmonyBox.style.display="none"; harmonyBox.innerHTML=""; }

      setStatus("Ready");
      showToast("Cleared");
      generate();
    }

    // ---------- Event wiring ----------
    function onAnyInput(){
  withUiLock(()=>{
    // auto-apply hand drawn preset by forcing variation
    if(c("handDrawnPreset")) setV("variation", "hand_drawn");

    // harmony only sets values/notes — should NOT generate
    applyHarmonyRules();

    // keep monitor dropdown visibility synced
    toggleScreenModeUI();
  });
}

    $("generateBtn").addEventListener("click", generate);
    $("copyBtn").addEventListener("click", copyPrompt);
    $("randomBtn").addEventListener("click", randomize);
    $("clearBtn").addEventListener("click", clearAll);

    // live harmony updates
    ["genreTone","palette","customPalette","gHorror","handDrawnPreset"].forEach(id=>{
      const el = $(id);
      if(el) el.addEventListener("change", onAnyInput);
    });

  window.addEventListener("load", ()=>{
  withUiLock(()=>{
    // setup stuff
    if (typeof loadPalettes === "function") loadPalettes();
    if (typeof ensurePaletteOptions === "function") ensurePaletteOptions();
    toggleScreenModeUI();
    applyHarmonyRules();
  });

  // run AFTER lock releases
  generate();
});
  </script>
</body>
</html>
